<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Practice Pro</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 16px; background: #f5f5f5; color: #333; }
    h1 { text-align: center; margin-bottom: 24px; }
    .menu, .question-area { max-width: 480px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    button { 
      width: 100%; padding: 16px; margin: 8px 0; font-size: 18px; 
      cursor: pointer; border-radius: 12px; border: 1px solid #ddd; 
      background-color: white; transition: 0.2s; font-weight: 500;
    }
    button:active { background-color: #eee; transform: scale(0.98); }
    .btn-portfolio { background-color: #007bff; color: white; border: none; }
    .btn-sheet { background-color: #34a853; color: white; border: none; }
    .btn-custom { background-color: #9c27b0; color: white; border: none; }
    .question { font-size: 26px; text-align: center; margin: 24px 0; font-weight: bold; min-height: 60px; line-height: 1.4; }
    .answer { font-size: 28px; text-align: center; color: #d93025; margin: 16px 0; display: none; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; }
    .timer { text-align: center; font-size: 18px; color: #666; font-weight: bold; }
    .loading { font-style: italic; color: #888; text-align: center; display: none; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Math Practice</h1>

<div class="menu" id="menu">
  <button class="btn-portfolio" onclick="startMode('portfolio')">üìà Portfolio Math</button>
  <button onclick="startMode('m12')">Multiplication 2‚Äì12</button>
  <button onclick="startMode('m2x1')">2-Digit √ó 1-Digit</button>
  <button onclick="startMode('m2x2')">2-Digit √ó 2-Digit</button>
  <button onclick="startMode('add3')">3-Digit Addition</button>
  
  <button class="btn-custom" onclick="startSheetMode()">üìù Custom Questions (Sheet)</button>
  <div id="loadingMsg" class="loading">Fetching questions...</div>

  <button class="btn-sheet" onclick="window.open('https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Dugmd2CtGnRreZoVHbDqlNiWi6t-xxMgIvoyU8KW1ueQxtL3TiI9YKuHcIjXNSd_Zkqf8V6VxaeE/pubhtml', '_blank')">
    üìä Open Google Sheet
  </button>
</div>

<div class="question-area" id="questionArea" style="display:none;">
  <div class="timer" id="timer">Time: 15</div>
  <div class="question" id="question"></div>
  <div class="answer" id="answer"></div>
  <button onclick="showAnswer()" style="background-color: #4285f4; color: white; border: none;">Show Answer</button>
  <button onclick="nextQuestion()">Next Question</button>
  <button onclick="backToMenu()" style="background-color: #eee; font-size: 14px;">Back to Menu</button>
</div>

<script>
  let currentMode = null, countdown = null, timeLeft = 0, sheetQuestions = [], isSheetMode = false;

  const modes = {
    portfolio: { time: 20 }, // New Mode
    m12: { minA: 2, maxA: 12, minB: 2, maxB: 12, op: '√ó', time: 8 },
    m2x1: { minA: 10, maxA: 99, minB: 2, maxB: 9, op: '√ó', time: 10 },
    m2x2: { minA: 10, maxA: 99, minB: 10, maxB: 99, op: '√ó', time: 12 },
    add3: { minA: 100, maxA: 999, minB: 100, maxB: 999, op: '+', time: 15 }
  };

  function generatePortfolioQuestion() {
    const units = [
      { label: 'thousand', val: 1000, short: 'k' },
      { label: 'million', val: 1000000, short: 'm' },
      { label: 'billion', val: 1000000000, short: 'b' }
    ];
    
    const type = Math.random() > 0.5 ? 'percentage' : 'ratio';

    if (type === 'percentage') {
      const isBps = Math.random() > 0.5;
      const rate = isBps ? (Math.floor(Math.random() * 40) + 1) * 5 : (Math.floor(Math.random() * 15) + 1);
      const unitObj = units[Math.floor(Math.random() * units.length)];
      const amount = Math.floor(Math.random() * 50) + 1;
      
      const rateText = isBps ? `${rate} bps` : `${rate}%`;
      const multiplier = isBps ? rate / 10000 : rate / 100;
      const rawAnswer = amount * unitObj.val * multiplier;
      
      return {
        q: `What is ${rateText} on ${amount} ${unitObj.label}?`,
        a: formatFinance(rawAnswer)
      };
    } else {
      // Division/Exposure logic
      const u1 = units[Math.floor(Math.random() * 3)];
      const u2 = units[Math.floor(Math.random() * 2) + 1]; // m or b
      const amt1 = (Math.floor(Math.random() * 50) + 1) * (Math.random() > 0.5 ? 1 : -1);
      const amt2 = Math.floor(Math.random() * 50) + 1;
      
      const verbs = [
        `This is ${amt1}${u1.short} of exposure on ${amt2}${u2.short} in GMV.`,
        `The portfolio ${amt1 >= 0 ? 'gained' : 'lost'} ${Math.abs(amt1)}${u1.short} on ${amt2}${u2.short} in GMV.`
      ];
      
      const rawRatio = (amt1 * u1.val) / (amt2 * u2.val);
      const bpsResult = (rawRatio * 10000).toFixed(2);
      
      return {
        q: verbs[Math.floor(Math.random() * verbs.length)] + "<br>Basis points?",
        a: `${bpsResult} bps`
      };
    }
  }

  function formatFinance(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + " million";
    if (num >= 1000) return (num / 1000).toFixed(2) + " thousand";
    return num.toLocaleString();
  }

  // --- CORE APP LOGIC ---
  function startMode(modeKey) {
    isSheetMode = false;
    currentMode = modeKey;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('questionArea').style.display = 'block';
    nextQuestion();
  }

  function nextQuestion() {
    clearInterval(countdown);
    document.getElementById('answer').style.display = 'none';
    let qText, aText;

    if (currentMode === 'portfolio') {
      const p = generatePortfolioQuestion();
      qText = p.q; aText = p.a;
      startTimer(20);
    } else if (isSheetMode) {
      let randomIdx = Math.floor(Math.random() * sheetQuestions.length);
      qText = sheetQuestions[randomIdx].q;
      aText = sheetQuestions[randomIdx].a;
      startTimer(15);
    } else {
      const m = modes[currentMode];
      let a = Math.floor(Math.random() * (m.maxA - m.minA + 1)) + m.minA;
      let b = Math.floor(Math.random() * (m.maxB - m.minB + 1)) + m.minB;
      aText = (m.op === '√ó') ? a * b : a + b;
      qText = `${a} ${m.op} ${b}`;
      startTimer(m.time);
    }

    document.getElementById('question').innerHTML = qText;
    document.getElementById('answer').textContent = aText;
    // Speak only the text, stripping HTML
    speak(qText.replace(/<br>/g, ' '));
  }

  // (Keeping your existing startTimer, showAnswer, backToMenu, speak, and sheet logic functions...)
  function startTimer(seconds) {
    timeLeft = seconds;
    document.getElementById('timer').textContent = `Time: ${timeLeft}`;
    countdown = setInterval(() => {
      timeLeft--;
      document.getElementById('timer').textContent = `Time: ${timeLeft}`;
      if (timeLeft <= 0) { clearInterval(countdown); document.getElementById('timer').textContent = "Time Up!"; }
    }, 1000);
  }
  function showAnswer() { document.getElementById('answer').style.display = 'block'; }
  function backToMenu() { clearInterval(countdown); document.getElementById('questionArea').style.display = 'none'; document.getElementById('menu').style.display = 'block'; }
  function speak(text) { const utter = new SpeechSynthesisUtterance(text); utter.rate = 0.9; speechSynthesis.cancel(); speechSynthesis.speak(utter); }

  async function startSheetMode() {
    const csvUrl = `https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Dugmd2CtGnRreZoVHbDqlNiWi6t-xxMgIvoyU8KW1ueQxtL3TiI9YKuHcIjXNSd_Zkqf8V6VxaeE/pub?output=csv`;
    try {
      const response = await fetch(csvUrl);
      const data = await response.text();
      const rows = data.split('\n').map(row => row.split(','));
      sheetQuestions = rows.map(cols => ({ q: cols[0]?.trim(), a: cols[1]?.trim() }))
        .filter(i => i.q && i.q.toLowerCase() !== "question");
      if (sheetQuestions.length > 0) { isSheetMode = true; currentMode = null; startMode(null); }
    } catch (e) { alert("Error loading sheet."); }
  }
</script>
</body>
</html>
